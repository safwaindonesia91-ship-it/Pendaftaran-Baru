import React, { useMemo, useState, useEffect } from "react";

// RPL Compliance Edu System — React App (v2)
// New features:
// - Role & Permissions (Unit RPL, Asesor, Senat, SPMI)
// - Upload dokumen dengan validasi tipe (Transkrip, Silabus, Logbook, Sertifikat)
// - Template BA/Risalah Panel + penomoran otomatis & unduh
// - Audit Trail (timestamp, user, aksi)
// - Mock API endpoint (JSON Server style) with graceful fallback to localStorage
// - Hook untuk "GPT Custom Action" (opsional) agar bisa mengelola data via endpoint

// ──────────────────────────────────────────────────────────────────────────────
// Konfigurasi API
// Ganti BASE_URL ke server JSON Server kamu (mis: http://localhost:3001)
const BASE_URL = localStorage.getItem("rpl.apiBase") || ""; // kosong = offline/localStorage

// Endpoint collection (JSON Server):
//   GET/POST   /applicants
//   GET/POST   /evidence
//   GET/POST   /decisions
//   GET/POST   /audit
//   GET/PUT    /settings (single row id=1)

async function apiFetch(path, opts = {}) {
  if (!BASE_URL) throw new Error("API disabled");
  const res = await fetch(`${BASE_URL}${path}`, {
    headers: { "Content-Type": "application/json" },
    ...opts,
  });
  if (!res.ok) throw new Error(`API ${res.status}`);
  return await res.json();
}

// GPT Custom Action hook: panggil endpoint tertentu dengan payload bebas
// Contoh: await gptAction("/actions/upsert", { entity: "evidence", data: {...} })
async function gptAction(path, payload) {
  if (!BASE_URL) throw new Error("API disabled");
  const res = await fetch(`${BASE_URL}${path}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ source: "gpt-custom", payload, at: new Date().toISOString() }),
  });
  if (!res.ok) throw new Error(`GPT Action failed: ${res.status}`);
  return await res.json();
}

// ──────────────────────────────────────────────────────────────────────────────
const PRINSIP = [
  { key: "legalitas", label: "Legalitas", desc: "PT memiliki legalitas & aturan internal RPL." },
  { key: "akses", label: "Aksesibilitas", desc: "Akses adil & inklusif; informasi mudah diakses." },
  { key: "kesetaraan", label: "Kesetaraan", desc: "CP nonformal/informal/kerja setara dengan formal." },
  { key: "transparan", label: "Transparansi", desc: "Kebijakan, proses, kriteria & hasil terbuka." },
  { key: "mutu", label: "Jaminan Mutu", desc: "Asesmen relevan, adil, terpercaya; terdokumentasi." },
  { key: "kelembagaan", label: "Kelembagaan", desc: "Senat, SPMI, Unit/Tim RPL & asesor berfungsi." },
];

const DEFAULT_CP = [
  { id: "cp1", domain: "Sikap", name: "Menjunjung etika akademik & profesi" },
  { id: "cp2", domain: "Keterampilan Umum", name: "Berpikir kritis & komunikasi efektif" },
  { id: "cp3", domain: "Penguasaan Pengetahuan", name: "Penguasaan dasar bidang prodi" },
  { id: "cp4", domain: "Keterampilan Khusus", name: "Mendemonstrasikan praktik inti prodi" },
  { id: "cp5", domain: "Keterampilan Khusus", name: "Menyusun RPS/kontrak & evaluasi belajar (untuk Dosen)" },
];

const DEFAULT_MK = [
  { code: "MK101", name: "Pengantar Disiplin", sks: 3, maps: ["cp1", "cp2", "cp3"] },
  { code: "MK201", name: "Praktik Inti", sks: 4, maps: ["cp2", "cp3", "cp4"] },
  { code: "MK301", name: "Desain Instruksional", sks: 2, maps: ["cp2", "cp5"] },
];

const ROLES = [
  { id: "unit", name: "Unit RPL" },
  { id: "asesor", name: "Asesor" },
  { id: "senat", name: "Senat" },
  { id: "spmi", name: "SPMI" },
];

const PERMS = {
  // Peran → Aksi yg diizinkan
  unit: ["create_applicant", "upload_doc", "update_cp_map", "export", "submit_to_asesor"],
  asesor: ["review", "record_evidence", "panel_decision", "generate_ba", "log_audit"],
  senat: ["endorse", "log_audit"],
  spmi: ["quality_check", "log_audit"],
};

function useLocalStorage(key, initial) {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch {}
  }, [key, state]);
  return [state, setState];
}

function Section({ title, children, right }) {
  return (
    <section className="bg-white/80 rounded-2xl shadow-sm border p-6 mb-6">
      <div className="flex items-center justify-between gap-4 mb-4">
        <h2 className="text-xl font-semibold">{title}</h2>
        {right}
      </div>
      {children}
    </section>
  );
}

function Badge({ children }) {
  return <span className="px-2 py-1 rounded-full text-xs bg-slate-100 border">{children}</span>;
}
function Pill({ active, onClick, children }) {
  return (
    <button
      onClick={onClick}
      className={
        "px-3 py-1.5 rounded-full border text-sm " +
        (active ? "bg-slate-900 text-white" : "bg-white hover:bg-slate-50")
      }
    >
      {children}
    </button>
  );
}
function Table({ columns, rows, empty = "Tidak ada data" }) {
  return (
    <div className="overflow-x-auto">
      <table className="min-w-full border rounded-xl overflow-hidden">
        <thead className="bg-slate-50">
          <tr>
            {columns.map((c) => (
              <th key={c.key} className="text-left text-sm font-medium px-3 py-2 border-b">
                {c.header}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rows.length === 0 ? (
            <tr>
              <td colSpan={columns.length} className="text-center text-sm px-3 py-4">
                {empty}
              </td>
            </tr>
          ) : (
            rows.map((row, idx) => (
              <tr key={idx} className="hover:bg-slate-50">
                {columns.map((c) => (
                  <td key={c.key} className="text-sm px-3 py-2 border-b align-top">
                    {typeof c.render === "function" ? c.render(row) : row[c.key]}
                  </td>
                ))}
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
}

function JsonExportButton({ data, filename = "rpl-data.json", disabled }) {
  return (
    <button
      disabled={disabled}
      className={`px-4 py-2 rounded-xl ${disabled ? "bg-slate-200 text-slate-500" : "bg-slate-900 text-white hover:opacity-90"}`}
      onClick={() => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }}
    >
      Export JSON
    </button>
  );
}
function UploadButton({ onLoad }) {
  return (
    <label className="px-4 py-2 rounded-xl bg-white border cursor-pointer hover:bg-slate-50">
      Import JSON
      <input
        type="file"
        accept="application/json"
        className="hidden"
        onChange={(e) => {
          const f = e.target.files?.[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const json = JSON.parse(String(ev.target?.result || "{}"));
              onLoad?.(json);
            } catch (err) {
              alert("File JSON tidak valid");
            }
          };
          reader.readAsText(f);
        }}
      />
    </label>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
// Role & Permissions UI
function RoleBar({ role, setRole, apiEnabled, setApiEnabled, apiBase, setApiBase }) {
  return (
    <div className="flex flex-wrap items-center gap-2">
      {ROLES.map((r) => (
        <Pill key={r.id} active={role === r.id} onClick={() => setRole(r.id)}>
          {r.name}
        </Pill>
      ))}
      <span className="mx-2 text-slate-400">|</span>
      <label className="flex items-center gap-2 text-sm">
        <input
          type="checkbox"
          checked={apiEnabled}
          onChange={(e) => setApiEnabled(e.target.checked)}
        />
        Enable API
      </label>
      <input
        className="border rounded-xl px-3 py-1 text-sm"
        placeholder="http://localhost:3001"
        value={apiBase}
        onChange={(e) => setApiBase(e.target.value)}
        style={{ minWidth: 220 }}
      />
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
// Upload Dokumen + Validasi
const DOC_TYPES = [
  { id: "transkrip", label: "Transkrip", accept: ["application/pdf", "image/", "application/vnd.openxmlformats-officedocument.wordprocessingml.document", "application/msword"] },
  { id: "silabus", label: "Silabus", accept: ["application/pdf", "application/msword", "application/vnd.openxmlformats-officedocument.wordprocessingml.document"] },
  { id: "logbook", label: "Logbook", accept: ["application/pdf", "text/plain", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "application/vnd.ms-excel"] },
  { id: "sertifikat", label: "Sertifikat", accept: ["application/pdf", "image/"] },
];
function accepts(mime, acceptList) {
  return acceptList.some((a) => (a.endsWith("/") ? mime.startsWith(a) : mime === a));
}
function UploadValidated({ items, setItems, canUpload }) {
  const [draftType, setDraftType] = useState("transkrip");
  const onFile = (file) => {
    const conf = DOC_TYPES.find((d) => d.id === draftType);
    if (!conf) return alert("Tipe tidak dikenali");
    if (!accepts(file.type || "", conf.accept)) return alert(`File harus bertipe: ${conf.accept.join(", ")}`);
    const rec = {
      id: crypto.randomUUID(),
      kind: conf.id,
      name: file.name,
      size: file.size,
      type: file.type,
      at: new Date().toISOString(),
    };
    setItems([rec, ...items]);
  };
  return (
    <div className="space-y-3">
      <div className="flex flex-wrap items-center gap-2">
        <select
          className="border rounded-xl px-3 py-2"
          value={draftType}
          onChange={(e) => setDraftType(e.target.value)}
          disabled={!canUpload}
        >
          {DOC_TYPES.map((t) => (
            <option key={t.id} value={t.id}>
              {t.label}
            </option>
          ))}
        </select>
        <label className={`px-4 py-2 rounded-xl border ${canUpload ? "cursor-pointer bg-white hover:bg-slate-50" : "bg-slate-100 text-slate-500"}`}>
          Upload File
          <input
            type="file"
            className="hidden"
            disabled={!canUpload}
            onChange={(e) => {
              const f = e.target.files?.[0];
              if (f) onFile(f);
              e.target.value = "";
            }}
          />
        </label>
      </div>
      <Table
        columns={[
          { key: "kind", header: "Jenis", render: (r) => DOC_TYPES.find((d) => d.id === r.kind)?.label || r.kind },
          { key: "name", header: "Nama" },
          { key: "type", header: "MIME" },
          { key: "size", header: "Ukuran" },
          { key: "at", header: "Diunggah" },
        ]}
        rows={items}
        empty="Belum ada dokumen"
      />
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
// BA/Risalah Panel + Penomoran otomatis & unduh
function autoBANumber(prefix = "BA/RPL") {
  const seq = Number(localStorage.getItem("rpl.ba.seq") || 0) + 1;
  localStorage.setItem("rpl.ba.seq", String(seq));
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  return `${prefix}/${y}.${m}/${String(seq).padStart(4, "0")}`;
}
function downloadText(filename, content) {
  const blob = new Blob([content], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
function BATemplate({ decision, applicant, panel, onGenerate }) {
  const [noBA, setNoBA] = useState(decision?.beritaAcara || "");
  useEffect(() => {
    if (!noBA) setNoBA(autoBANumber());
    // eslint-disable-next-line
  }, []);
  const text = `BERITA ACARA PANEL ASESMEN RPL
Nomor: ${noBA}
Tanggal: ${new Date().toLocaleString()}

Pemohon: ${applicant?.name || "-"} (ID: ${applicant?.id || "-"})
Panel: ${(panel || []).map((p) => p).join(", ")}
Status Keputusan: ${decision?.status || "Pending"}
Catatan: ${decision?.notes || "-"}

Rincian:
- Level KKNI (jika Tipe B): ${decision?.kkni || "-"}
- No. Referensi Internal: ${decision?.ref || "-"}

Ditandatangani oleh panel pada tanggal di atas.`;
  return (
    <div className="space-y-2">
      <div className="grid md:grid-cols-3 gap-2">
        <input className="border rounded-xl px-3 py-2" value={noBA} onChange={(e) => setNoBA(e.target.value)} />
        <input
          className="border rounded-xl px-3 py-2"
          placeholder="No. Referensi Internal"
          value={decision?.ref || ""}
          onChange={(e) => onGenerate({ ...decision, ref: e.target.value, beritaAcara: noBA })}
        />
        <input
          className="border rounded-xl px-3 py-2"
          placeholder="Level KKNI (opsional)"
          value={decision?.kkni || ""}
          onChange={(e) => onGenerate({ ...decision, kkni: e.target.value, beritaAcara: noBA })}
        />
      </div>
      <div className="flex flex-wrap gap-2">
        <button
          className="px-4 py-2 rounded-xl border"
          onClick={() => downloadText(`${noBA.replaceAll("/", "_")}.txt`, text)}
        >
          Unduh BA (.txt)
        </button>
        <button
          className="px-4 py-2 rounded-xl border"
          onClick={() => onGenerate({ ...decision, beritaAcara: noBA })}
        >
          Simpan Nomor BA
        </button>
      </div>
      <pre className="text-xs bg-slate-50 p-3 rounded-xl border whitespace-pre-wrap">{text}</pre>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
// Evidence editor + Audit Trail logger
function EvidenceEditor({ items, setItems, log, canEdit }) {
  const [draft, setDraft] = useState({ type: "Observasi", desc: "", source: "Langsung" });
  const add = () => {
    if (!canEdit) return;
    if (!draft.desc.trim()) return;
    const rec = { ...draft, id: crypto.randomUUID(), createdAt: new Date().toISOString() };
    setItems([rec, ...items]);
    setDraft({ type: "Observasi", desc: "", source: "Langsung" });
    log("record_evidence", `Tambah bukti: ${rec.type}`);
  };
  return (
    <div className="space-y-3">
      <div className="grid md:grid-cols-3 gap-3">
        <div>
          <label className="text-sm">Jenis Bukti</label>
          <select
            className="w-full mt-1 border rounded-xl px-3 py-2"
            value={draft.type}
            onChange={(e) => setDraft({ ...draft, type: e.target.value })}
            disabled={!canEdit}
          >
            {["Observasi", "Ujian Lisan", "Ujian Tulis", "Demonstrasi", "Portofolio", "Log Book", "Referensi Pihak Ketiga", "Proyek/Simulasi"].map((t) => (
              <option key={t}>{t}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="text-sm">Sumber</label>
          <select
            className="w-full mt-1 border rounded-xl px-3 py-2"
            value={draft.source}
            onChange={(e) => setDraft({ ...draft, source: e.target.value })}
            disabled={!canEdit}
          >
            {["Langsung", "Tidak Langsung", "Tambahan"].map((s) => (
              <option key={s}>{s}</option>
            ))}
          </select>
        </div>
        <div className="md:col-span-3">
          <label className="text-sm">Deskripsi / Catatan</label>
          <textarea
            className="w-full mt-1 border rounded-xl px-3 py-2"
            rows={3}
            placeholder="Ringkas bukti & keterkaitannya dengan CP/MK"
            value={draft.desc}
            onChange={(e) => setDraft({ ...draft, desc: e.target.value })}
            disabled={!canEdit}
          />
        </div>
      </div>
      <button onClick={add} className={`px-4 py-2 rounded-xl ${canEdit ? "bg-slate-900 text-white" : "bg-slate-200 text-slate-500"}`}>
        Tambah Bukti
      </button>
      <Table
        columns={[
          { key: "createdAt", header: "Waktu" },
          { key: "type", header: "Jenis" },
          { key: "source", header: "Sumber" },
          { key: "desc", header: "Deskripsi" },
        ]}
        rows={items}
        empty="Belum ada bukti"
      />
    </div>
  );
}

function DecisionPanel({ decision, setDecision, canDecide, log }) {
  return (
    <div className="flex flex-col md:flex-row md:items-center gap-3">
      <select
        className="border rounded-xl px-3 py-2"
        value={decision.status}
        onChange={(e) => {
          if (!canDecide) return; const v = e.target.value; setDecision({ ...decision, status: v }); log("panel_decision", `Status→${v}`);
        }}
        disabled={!canDecide}
      >
        <option value="Pending">Pending</option>
        <option value="Lulus">Lulus</option>
        <option value="Gagal">Gagal</option>
      </select>
      <input
        className="border rounded-xl px-3 py-2 flex-1"
        placeholder="Catatan/risalah panel asesmen"
        value={decision.notes}
        onChange={(e) => { if (!canDecide) return; setDecision({ ...decision, notes: e.target.value }); }}
        disabled={!canDecide}
      />
      <input
        className="border rounded-xl px-3 py-2"
        placeholder="No. Berita Acara"
        value={decision.beritaAcara || ""}
        onChange={(e) => { if (!canDecide) return; setDecision({ ...decision, beritaAcara: e.target.value }); }}
        disabled={!canDecide}
      />
    </div>
  );
}

function SKPreview({ tipe, applicant, recognized, totalSks, kkniLevel, decision }) {
  const today = new Date().toLocaleDateString();
  return (
    <div className="border rounded-2xl p-4 bg-slate-50">
      <div className="text-center font-semibold">Ringkasan {tipe === "A" ? "SK Pembebasan SKS" : "SK Pengakuan Kesetaraan"}</div>
      <div className="text-sm mt-2 space-y-1">
        <div><b>Nama Pemohon:</b> {applicant?.name || "-"}</div>
        <div><b>NIK/ID:</b> {applicant?.id || "-"}</div>
        <div><b>Tanggal:</b> {today}</div>
        {tipe === "A" ? (
          <>
            <div className="mt-2"><b>Total SKS Diakui:</b> {totalSks}</div>
            <Table
              columns={[{ key: "code", header: "Kode" }, { key: "name", header: "Mata Kuliah" }, { key: "sks", header: "SKS Diakui" }]}
              rows={recognized}
              empty="Tidak ada MK diakui"
            />
          </>
        ) : (
          <>
            <div className="mt-2"><b>Level KKNI Disetarakan:</b> {kkniLevel || decision?.kkni || "-"}</div>
            <div><b>Status Penetapan:</b> {decision?.status || "Pending"}</div>
            <div><b>No. Berita Acara:</b> {decision?.beritaAcara || "-"}</div>
            <div><b>Catatan:</b> {decision?.notes || "-"}</div>
          </>
        )}
      </div>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
export default function App() {
  const [tab, setTab] = useState("overview");
  const [subA, setSubA] = useState("A1");

  const [cp, setCp] = useLocalStorage("rpl.cp", DEFAULT_CP);
  const [mk, setMk] = useLocalStorage("rpl.mk", DEFAULT_MK);
  const [cpRatings, setCpRatings] = useLocalStorage("rpl.ratings", {});
  const [evidence, setEvidence] = useLocalStorage("rpl.evidence", []);
  const [checklist, setChecklist] = useLocalStorage("rpl.check", {});
  const [applicant, setApplicant] = useLocalStorage("rpl.applicant", { name: "", id: "" });
  const [decision, setDecision] = useLocalStorage("rpl.decision", { status: "Pending", notes: "", beritaAcara: "" });
  const [kkniLevel, setKkniLevel] = useLocalStorage("rpl.kkni", "");
  const [docs, setDocs] = useLocalStorage("rpl.docs", []);
  const [audit, setAudit] = useLocalStorage("rpl.audit", []);

  const [role, setRole] = useLocalStorage("rpl.role", "unit");
  const [apiEnabled, setApiEnabled] = useLocalStorage("rpl.apiEnabled", false);
  const [apiBase, setApiBase] = useLocalStorage("rpl.apiBase", BASE_URL);

  useEffect(() => {
    localStorage.setItem("rpl.apiBase", apiBase || "");
  }, [apiBase]);

  const can = (action) => (PERMS[role] || []).includes(action);

  const log = async (action, detail) => {
    const entry = { id: crypto.randomUUID(), at: new Date().toISOString(), userRole: role, action, detail };
    setAudit([entry, ...audit]);
    try {
      if (apiEnabled && apiBase) await apiFetch("/audit", { method: "POST", body: JSON.stringify(entry) });
    } catch {}
  };

  const recognized = useMemo(() => {
    return mk
      .map((m) => ({ code: m.code, name: m.name, sks: mkSksRecognized(cpRatings, m) }))
      .filter((x) => x.sks > 0);
  }, [mk, cpRatings]);
  const totalSks = useMemo(() => recognized.reduce((a, b) => a + b.sks, 0), [recognized]);

  const dataBundle = { meta: { version: 2 }, cp, mk, cpRatings, evidence, checklist, applicant, decision, kkniLevel, docs, audit, role };
  const importBundle = (json) => {
    if (!json || typeof json !== "object") return;
    setApplicant(json.applicant ?? applicant);
    setCp(json.cp ?? cp);
    setMk(json.mk ?? mk);
    setCpRatings(json.cpRatings ?? cpRatings);
    setEvidence(json.evidence ?? evidence);
    setChecklist(json.checklist ?? checklist);
    setDecision(json.decision ?? decision);
    setKkniLevel(json.kkniLevel ?? kkniLevel);
    setDocs(json.docs ?? docs);
    setAudit(json.audit ?? audit);
    setRole(json.role ?? role);
  };

  // Recognizer
  function mkSksRecognized(cpRatings, mk) {
    const ratings = mk.maps.map((cp) => cpRatings[cp] || 0);
    if (ratings.every((r) => r >= 4)) return mk.sks;
    if (ratings.every((r) => r >= 3)) return Math.ceil(mk.sks / 2);
    return 0;
  }

  // Sync minimal data to API if enabled
  useEffect(() => {
    (async () => {
      if (!apiEnabled || !apiBase) return;
      try {
        await apiFetch("/settings/1").catch(async () =>
          apiFetch("/settings", { method: "POST", body: JSON.stringify({ id: 1, createdAt: new Date().toISOString() }) })
        );
      } catch {}
    })();
  }, [apiEnabled, apiBase]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900">
      <header className="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center font-bold">RPL</div>
            <div>
              <div className="font-semibold">RPL Compliance Edu System</div>
              <div className="text-xs text-slate-500">Role/Permissions • Upload • BA • Audit • API • GPT Action</div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <RoleBar role={role} setRole={setRole} apiEnabled={apiEnabled} setApiEnabled={setApiEnabled} apiBase={apiBase || ""} setApiBase={setApiBase} />
            <UploadButton onLoad={importBundle} />
            <JsonExportButton data={dataBundle} />
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 py-6">
        <nav className="flex flex-wrap gap-2 mb-6">
          {[
            ["overview", "Overview"],
            ["typeA", "RPL Tipe A"],
            ["typeB", "RPL Tipe B"],
            ["asses", "Asesmen"],
            ["docs", "Dokumen"],
            ["audit", "Audit Trail"],
            ["settings", "Settings"],
          ].map(([k, label]) => (
            <Pill key={k} active={tab === k} onClick={() => setTab(k)}>
              {label}
            </Pill>
          ))}
        </nav>

        {tab === "overview" && (
          <>
            <Section title="Compliance Checklist (Prinsip Penyelenggaraan)" right={<Badge>Role: {ROLES.find((r) => r.id === role)?.name}</Badge>}>
              <div className="grid md:grid-cols-2 gap-3">
                {PRINSIP.map((p) => (
                  <label key={p.key} className="flex gap-3 items-start p-3 border rounded-xl bg-slate-50/60">
                    <input
                      type="checkbox"
                      checked={!!checklist[p.key]}
                      onChange={(e) => setChecklist({ ...checklist, [p.key]: e.target.checked })}
                    />
                    <div>
                      <div className="font-medium">{p.label}</div>
                      <div className="text-sm text-slate-600">{p.desc}</div>
                    </div>
                  </label>
                ))}
              </div>
            </Section>
            <Section title="Struktur CP & Peta MK">
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium mb-2">Daftar CP</h3>
                  <Table columns={[{ key: "domain", header: "Domain" }, { key: "name", header: "Uraian" }]} rows={cp} empty="Belum ada CP" />
                </div>
                <div>
                  <h3 className="font-medium mb-2">Mata Kuliah & Pemetaan CP</h3>
                  <Table
                    columns={[
                      { key: "code", header: "Kode" },
                      { key: "name", header: "Nama MK" },
                      { key: "sks", header: "SKS" },
                      { key: "maps", header: "Memenuhi CP", render: (row) => <div className="flex flex-wrap gap-1">{row.maps.map((m) => <Badge key={m}>{cp.find((x) => x.id === m)?.name || m}</Badge>)}</div> },
                    ]}
                    rows={mk}
                    empty="Belum ada MK"
                  />
                </div>
              </div>
            </Section>
          </>
        )}

        {tab === "typeA" && (
          <>
            <div className="mb-4 flex gap-2">
              {["A1", "A2"].map((s) => (
                <Pill key={s} active={subA === s} onClick={() => setSubA(s)}>
                  {s === "A1" ? "A1 — Alih Kredit (Formal)" : "A2 — Nonformal/Kerja"}
                </Pill>
              ))}
            </div>
            <Section title={subA === "A1" ? "RPL Tipe A1 (Credit Transfer)" : "RPL Tipe A2 (Nonformal/Informal/Pengalaman Kerja)"} right={<Badge>{subA}</Badge>}>
              <div className="grid md:grid-cols-3 gap-4 mb-6">
                <input className="border rounded-xl px-3 py-2" placeholder="Nama Pemohon" value={applicant.name} onChange={(e) => setApplicant({ ...applicant, name: e.target.value })} />
                <input className="border rounded-xl px-3 py-2" placeholder="NIK/ID Pemohon" value={applicant.id} onChange={(e) => setApplicant({ ...applicant, id: e.target.value })} />
                <input type="file" className="border rounded-xl px-3 py-2" title="Upload transkrip/silabus" disabled={!can("upload_doc")} />
              </div>

              {subA === "A2" && (
                <>
                  <h3 className="font-medium mb-2">Asesmen Mandiri terhadap CP</h3>
                  <div className="space-y-3">
                    {cp.map((c) => (
                      <div key={c.id} className="p-3 border rounded-xl flex items-center gap-4 bg-white">
                        <div className="min-w-[180px]"><div className="font-medium">{c.name}</div><div className="text-xs text-slate-500">Domain: {c.domain}</div></div>
                        <div className="flex items-center gap-2">
                          {[1, 2, 3, 4, 5].map((v) => (
                            <button key={v} onClick={() => setCpRatings({ ...cpRatings, [c.id]: v })} className={"w-9 h-9 rounded-full border text-sm " + (cpRatings[c.id] === v ? "bg-slate-900 text-white" : "bg-white hover:bg-slate-50")} title={v === 1 ? "Tidak mampu" : v === 2 ? "Kurang mampu" : v === 3 ? "Cukup" : v === 4 ? "Mampu" : "Sangat mampu"}>
                              {v}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}

              <div className="mt-6 grid md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium mb-2">Rekomendasi Pembebasan MK</h3>
                  <Table columns={[{ key: "code", header: "Kode" }, { key: "name", header: "Mata Kuliah" }, { key: "sks", header: "SKS Diakui" }]} rows={recognized} empty="Belum ada rekomendasi" />
                </div>
                <div>
                  <SKPreview tipe="A" applicant={applicant} recognized={recognized} totalSks={totalSks} />
                </div>
              </div>
            </Section>
          </>
        )}

        {tab === "typeB" && (
          <>
            <Section title="RPL Tipe B — Pengakuan Kesetaraan KKNI (Dosen/Instruktur/Tutor)">
              <div className="grid md:grid-cols-3 gap-4 mb-4">
                <input className="border rounded-xl px-3 py-2" placeholder="Nama Calon" value={applicant.name} onChange={(e) => setApplicant({ ...applicant, name: e.target.value })} />
                <input className="border rounded-xl px-3 py-2" placeholder="NIK/ID Calon" value={applicant.id} onChange={(e) => setApplicant({ ...applicant, id: e.target.value })} />
                <select className="border rounded-xl px-3 py-2" value={kkniLevel} onChange={(e) => setKkniLevel(e.target.value)}>
                  <option value="">Level KKNI Disasar</option>
                  {[6, 7, 8, 9].map((l) => (
                    <option key={l} value={String(l)}>
                      {l}
                    </option>
                  ))}
                </select>
              </div>
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium mb-2">Bukti & Rekam Jejak</h3>
                  <EvidenceEditor items={evidence} setItems={setEvidence} log={log} canEdit={can("record_evidence")} />
                </div>
                <div className="space-y-4">
                  <h3 className="font-medium">Panel Keputusan</h3>
                  <DecisionPanel decision={decision} setDecision={setDecision} canDecide={can("panel_decision")} log={log} />
                  <BATemplate decision={decision} applicant={applicant} panel={["Asesor", "Senat", "SPMI"]} onGenerate={(d) => { setDecision(d); log("generate_ba", d.beritaAcara || "-"); }} />
                  <SKPreview tipe="B" applicant={applicant} kkniLevel={kkniLevel} decision={decision} />
                </div>
              </div>
            </Section>
          </>
        )}

        {tab === "asses" && (
          <>
            <Section title="Rubrik Asesmen (Ringkas)">
              <Table
                columns={[{ key: "komp", header: "Komponen" }, { key: "bukti", header: "Jenis Bukti" }, { key: "kriteria", header: "Kriteria Lulus" }]}
                rows={[
                  { komp: "Kesetaraan CP-MK", bukti: "Portofolio/Observasi/Ujian", kriteria: "CP pada MK terpenuhi minimal level 4" },
                  { komp: "Praktik/Simulasi", bukti: "Demonstrasi/Proyek", kriteria: "Tugas kinerja tuntas tanpa cacat kritis" },
                  { komp: "Wawasan & Etika", bukti: "Wawancara/Tertulis", kriteria: "Memahami konteks akademik & etika" },
                ]}
              />
            </Section>
            <Section title="Audit Trail & Catatan Panel">
              <div className="text-xs text-slate-500 mb-2">Aksi yang tercatat: create/review/decision/export/dll.</div>
              <Table
                columns={[{ key: "at", header: "Waktu" }, { key: "userRole", header: "Role" }, { key: "action", header: "Aksi" }, { key: "detail", header: "Detail" }]}
                rows={audit}
                empty="Belum ada log"
              />
            </Section>
          </>
        )}

        {tab === "docs" && (
          <Section title="Dokumen Pemohon (Validasi Tipe)" right={<Badge>{can("upload_doc") ? "Dapat Mengunggah" : "Hanya Lihat"}</Badge>}>
            <UploadValidated items={docs} setItems={(v) => { setDocs(v); log("upload_doc", `${v[0]?.kind || "-"}`); }} canUpload={can("upload_doc")} />
          </Section>
        )}

        {tab === "audit" && (
          <Section title="Audit Trail">
            <Table columns={[{ key: "at", header: "Waktu" }, { key: "userRole", header: "Role" }, { key: "action", header: "Aksi" }, { key: "detail", header: "Detail" }]} rows={audit} />
          </Section>
        )}

        {tab === "settings" && (
          <>
            <Section title="Kustomisasi Kurikulum & CP">
              <div className="text-sm text-slate-600 mb-3">Tambah/ubah CP & MK sesuai prodi. Pemetaan CP→MK dipakai untuk menghitung rekomendasi pembebasan SKS.</div>
              <div className="grid md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <h3 className="font-medium">Capaian Pembelajaran (CP)</h3>
                  {cp.map((c, i) => (
                    <div key={c.id} className="p-3 border rounded-xl flex gap-2 items-center bg-white">
                      <input className="border rounded-xl px-2 py-1 w-36" value={c.domain} onChange={(e) => { const next = [...cp]; next[i] = { ...c, domain: e.target.value }; setCp(next); }} />
                      <input className="border rounded-xl px-2 py-1 flex-1" value={c.name} onChange={(e) => { const next = [...cp]; next[i] = { ...c, name: e.target.value }; setCp(next); }} />
                      <button className="text-red-600" onClick={() => setCp(cp.filter((x) => x.id !== c.id))}>Hapus</button>
                    </div>
                  ))}
                  <button className="px-3 py-1.5 rounded-xl border" onClick={() => setCp([...cp, { id: crypto.randomUUID(), domain: "", name: "" }])}>+ Tambah CP</button>
                </div>
                <div className="space-y-2">
                  <h3 className="font-medium">Mata Kuliah (MK)</h3>
                  {mk.map((m, i) => (
                    <div key={m.code || i} className="p-3 border rounded-xl space-y-2 bg-white">
                      <div className="grid grid-cols-3 gap-2">
                        <input className="border rounded-xl px-2 py-1" value={m.code} onChange={(e) => { const next = [...mk]; next[i] = { ...m, code: e.target.value }; setMk(next); }} />
                        <input className="border rounded-xl px-2 py-1" value={m.name} onChange={(e) => { const next = [...mk]; next[i] = { ...m, name: e.target.value }; setMk(next); }} />
                        <input type="number" className="border rounded-xl px-2 py-1" value={m.sks} onChange={(e) => { const next = [...mk]; next[i] = { ...m, sks: Number(e.target.value || 0) }; setMk(next); }} />
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Pemetaan CP</div>
                        <div className="flex flex-wrap gap-2">
                          {cp.map((c) => {
                            const active = m.maps.includes(c.id);
                            return (
                              <button key={c.id} className={"px-2 py-1 rounded-full border text-xs " + (active ? "bg-slate-900 text-white" : "bg-white")} onClick={() => { const next = [...mk]; const maps = new Set(next[i].maps); if (active) maps.delete(c.id); else maps.add(c.id); next[i] = { ...m, maps: Array.from(maps) }; setMk(next); }}>
                                {c.name}
                              </button>
                            );
                          })}
                        </div>
                      </div>
                      <div className="text-xs text-slate-500">Heuristik pengakuan: semua CP terkait ≥4 ⇒ MK diakui penuh; semua ≥3 ⇒ ½ SKS dibulatkan ke atas.</div>
                      <div className="flex justify-end"><button className="text-red-600" onClick={() => setMk(mk.filter((x) => (x.code || i) !== (m.code || i)))}>Hapus MK</button></div>
                    </div>
                  ))}
                  <button className="px-3 py-1.5 rounded-xl border" onClick={() => setMk([...mk, { code: "", name: "", sks: 2, maps: [] }])}>+ Tambah MK</button>
                </div>
              </div>
            </Section>
            <Section title="API & GPT Custom Action">
              <div className="text-sm text-slate-600 mb-3">
                Saat API aktif, log & data penting dikirim ke endpoint JSON Server. GPT Custom bisa memukul <code>/actions/*</code> untuk melakukan upsert otomatis.
              </div>
              <Table
                columns={[{ key: "ep", header: "Endpoint" }, { key: "met", header: "Method" }, { key: "ex", header: "Contoh Payload" }]}
                rows={[
                  { ep: "/applicants", met: "POST", ex: "{ name, id }" },
                  { ep: "/evidence", met: "POST", ex: "{ type, source, desc, createdAt }" },
                  { ep: "/decisions", met: "POST", ex: "{ status, notes, beritaAcara }" },
                  { ep: "/audit", met: "POST", ex: "{ at, userRole, action, detail }" },
                  { ep: "/actions/upsert", met: "POST", ex: "{ entity, data } // GPT Custom" },
                ]}
              />
            </Section>
          </>
        )}
      </main>

      <footer className="max-w-6xl mx-auto px-4 py-8 text-center text-xs text-slate-500">
        Demo ini memetakan alur Pedoman RPL (Tipe A1/A2 & Tipe B) + Role/Permissions, Upload, BA, Audit, dan API hooks.
      </footer>
    </div>
  );
}
